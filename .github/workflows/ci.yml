name: CI

on:
  push:
    branches: [ main, cleanup-files ]
  pull_request:
    branches: [ main ]

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Typecheck
        run: npm run typecheck
      
      - name: Lint
        run: npm run lint

  test:
    name: Tests with Coverage
    runs-on: ubuntu-latest
    needs: quality  # Run after quality checks pass

    steps:
      - uses: actions/checkout@v4
      
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: npm run test:coverage
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7
      
      - name: Check coverage thresholds
        run: |
          # Parse coverage summary and check thresholds
          COVERAGE_FILE="coverage/coverage-summary.json"
          if [ -f "$COVERAGE_FILE" ]; then
            LINES=$(cat $COVERAGE_FILE | jq '.total.lines.pct')
            BRANCHES=$(cat $COVERAGE_FILE | jq '.total.branches.pct')
            FUNCTIONS=$(cat $COVERAGE_FILE | jq '.total.functions.pct')
            
            echo "ðŸ“Š Coverage Report:"
            echo "  Lines: ${LINES}%"
            echo "  Branches: ${BRANCHES}%"
            echo "  Functions: ${FUNCTIONS}%"
            
            # Minimum thresholds (adjust as codebase matures)
            MIN_LINES=50
            MIN_BRANCHES=40
            MIN_FUNCTIONS=50
            
            if (( $(echo "$LINES < $MIN_LINES" | bc -l) )); then
              echo "âŒ Line coverage ${LINES}% is below threshold ${MIN_LINES}%"
              exit 1
            fi
            
            echo "âœ… Coverage thresholds passed!"
          else
            echo "âš ï¸ No coverage report found, skipping threshold check"
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [quality, test]  # Run after both quality and test pass

    steps:
      - uses: actions/checkout@v4
      
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build