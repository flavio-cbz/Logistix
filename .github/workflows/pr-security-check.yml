name: PR Security Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

jobs:
  pr-security-check:
    name: PR Security Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Analyze Changed Files
        id: analyze-changes
        run: |
          echo "ğŸ” Analyse des fichiers modifiÃ©s..."
          
          # Obtenir la liste des fichiers modifiÃ©s
          git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD > changed-files.txt
          
          # VÃ©rifier si des endpoints API ont Ã©tÃ© modifiÃ©s
          API_CHANGES=$(grep -E "app/api/.*route\.(ts|js)$" changed-files.txt || echo "")
          
          if [ -n "$API_CHANGES" ]; then
            echo "api-changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Endpoints API modifiÃ©s dÃ©tectÃ©s:"
            echo "$API_CHANGES"
          else
            echo "api-changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun endpoint API modifiÃ©"
          fi
          
      - name: Validate API Security (if API changes)
        if: steps.analyze-changes.outputs.api-changes == 'true'
        run: |
          echo "ğŸ”’ Validation de la sÃ©curitÃ© des endpoints modifiÃ©s..."
          
          # Analyser la sÃ©curitÃ© actuelle
          node scripts/analyze-api-security.js > current-security.txt
          
          node <<'NODE'
          const fs = require('fs');
          const report = fs.readFileSync('current-security.txt', 'utf8');
          const match = report.match(/Pourcentage sÃ©curisÃ©:\s*([\d.]+)/i);
          const score = match ? Number(match[1]) : NaN;

          if (!Number.isFinite(score)) {
            console.error('âŒ Impossible de dÃ©terminer le score de sÃ©curitÃ©.');
            process.exit(1);
          }

          console.log(`ğŸ“Š Score de sÃ©curitÃ© actuel: ${score}%`);

          if (score < 35) {
            console.error('âŒ Ã‰CHEC: Le PR fait rÃ©gresser la sÃ©curitÃ© en dessous de 35%');
            console.error('ğŸ’¡ Veuillez sÃ©curiser les nouveaux endpoints avec validation Zod');
            process.exit(1);
          }

          console.log('âœ… SÃ©curitÃ© maintenue ou amÃ©liorÃ©e');
          NODE
          
      - name: Test Zod Schemas (if API changes)
        if: steps.analyze-changes.outputs.api-changes == 'true'
        run: |
          echo "ğŸ§ª Tests de validation via Vitest..."
          npm run test:unit
          
      - name: Security Summary Comment
        if: steps.analyze-changes.outputs.api-changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Lire le rapport de sÃ©curitÃ©
            let securityReport = '';
            try {
              securityReport = fs.readFileSync('current-security.txt', 'utf8');
            } catch (error) {
              securityReport = 'Rapport non disponible';
            }
            
            // Extraire les mÃ©triques
            const securedMatch = securityReport.match(/Endpoints sÃ©curisÃ©s: (\d+)/);
            const totalMatch = securityReport.match(/Total endpoints: (\d+)/);
            const percentageMatch = securityReport.match(/Pourcentage sÃ©curisÃ©: ([\d.]+)%/);
            
            const secured = securedMatch ? Number(securedMatch[1]) : 'N/A';
            const total = totalMatch ? Number(totalMatch[1]) : 'N/A';
            const percentage = percentageMatch ? Number(percentageMatch[1]) : 'N/A';
            
            const comment = `
            ## ğŸ” Analyse de SÃ©curitÃ© du PR
            
            ### ğŸ“Š Ã‰tat Actuel de la SÃ©curisation
            - **Endpoints sÃ©curisÃ©s:** ${secured}/${total}
            - **Pourcentage:** ${percentage}%
            - **Seuil minimum:** 35% ${percentage !== 'N/A' && percentage >= 35 ? 'âœ…' : 'âŒ'}
            
            ### ğŸ” Fichiers API ModifiÃ©s
            Ce PR modifie des endpoints API. La sÃ©curitÃ© a Ã©tÃ© automatiquement vÃ©rifiÃ©e.
            
            ### ğŸ“ Checklist de SÃ©curitÃ©
            ${percentage !== 'N/A' && percentage >= 35 ? '- âœ… Seuil de sÃ©curitÃ© respectÃ©' : '- âŒ Seuil de sÃ©curitÃ© non respectÃ©'}
            - ${percentage !== 'N/A' && percentage > 50 ? 'âœ…' : 'âš ï¸'} Couverture de sÃ©curisation ${percentage !== 'N/A' && percentage > 50 ? 'satisfaisante' : 'Ã  amÃ©liorer'}
            
            ### ğŸ’¡ Recommandations
            ${percentage !== 'N/A' && percentage < 40 ? '- âš ï¸ ConsidÃ©rer l\'ajout de validation Zod aux nouveaux endpoints\n- ğŸ“š Consulter `lib/schemas/index.ts` pour les schÃ©mas existants\n- ğŸ”§ Utiliser `lib/middleware/validation.ts` pour l\'intÃ©gration' : '- ğŸ‰ Bonne pratique de sÃ©curisation maintenue !'}
            
            ---
            *Analyse automatique par le systÃ¨me de sÃ©curitÃ© LogistiX*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
      - name: PR Security Status
        run: |
          echo "âœ… VALIDATION PR TERMINÃ‰E"
          echo "ğŸ” Les critÃ¨res de sÃ©curitÃ© sont respectÃ©s"
          echo "ğŸ’¡ Le PR peut Ãªtre mergÃ© du point de vue sÃ©curitÃ©"