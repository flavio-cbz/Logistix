7f3de7f3f4081c4a4739366826e10979
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const setup_1 = require("./setup");
(0, globals_1.describe)('Backend Test Setup', () => {
    (0, globals_1.describe)('Mock Utilities', () => {
        (0, globals_1.test)('should create mock request', () => {
            const req = (0, setup_1.createMockRequest)({ method: 'POST', url: '/api/test' });
            (0, globals_1.expect)(req.method).toBe('POST');
            (0, globals_1.expect)(req.url).toBe('/api/test');
            (0, globals_1.expect)(req.headers).toBeDefined();
            (0, globals_1.expect)(req.query).toBeDefined();
        });
        (0, globals_1.test)('should create mock response', () => {
            const res = (0, setup_1.createMockResponse)();
            (0, globals_1.expect)(res.status).toBeDefined();
            (0, globals_1.expect)(res.json).toBeDefined();
            (0, globals_1.expect)(res.send).toBeDefined();
            (0, globals_1.expect)(res.setHeader).toBeDefined();
        });
        (0, globals_1.test)('should create mock database', () => {
            const db = (0, setup_1.createMockDatabase)();
            (0, globals_1.expect)(db.prepare).toBeDefined();
            (0, globals_1.expect)(db.exec).toBeDefined();
            (0, globals_1.expect)(db.close).toBeDefined();
            (0, globals_1.expect)(db.transaction).toBeDefined();
        });
    });
    (0, globals_1.describe)('Database Test Utils', () => {
        (0, globals_1.test)('should create in-memory database', () => {
            const db = setup_1.DatabaseTestUtils.createInMemoryDatabase();
            (0, globals_1.expect)(db).toBeDefined();
            db.close();
        });
        (0, globals_1.test)('should initialize test schema', async () => {
            const db = setup_1.DatabaseTestUtils.createInMemoryDatabase();
            await setup_1.DatabaseTestUtils.initializeTestSchema(db);
            // Verify tables exist
            const tables = db.prepare(`
        SELECT name FROM sqlite_master 
        WHERE type='table' AND name NOT LIKE 'sqlite_%'
      `).all();
            const tableNames = tables.map((t) => t.name);
            (0, globals_1.expect)(tableNames).toContain('users');
            (0, globals_1.expect)(tableNames).toContain('parcelles');
            (0, globals_1.expect)(tableNames).toContain('products');
            (0, globals_1.expect)(tableNames).toContain('sessions');
            db.close();
        });
        (0, globals_1.test)('should seed test data', async () => {
            const db = setup_1.DatabaseTestUtils.createInMemoryDatabase();
            await setup_1.DatabaseTestUtils.initializeTestSchema(db);
            const seededData = await setup_1.DatabaseTestUtils.seedTestData(db);
            (0, globals_1.expect)(seededData.user).toBeDefined();
            (0, globals_1.expect)(seededData.parcelle).toBeDefined();
            (0, globals_1.expect)(seededData.product).toBeDefined();
            (0, globals_1.expect)(seededData.session).toBeDefined();
            // Verify data was inserted
            const userCount = db.prepare('SELECT COUNT(*) as count FROM users').get();
            (0, globals_1.expect)(userCount.count).toBeGreaterThan(0);
            db.close();
        });
        (0, globals_1.test)('should clean database', async () => {
            const db = setup_1.DatabaseTestUtils.createInMemoryDatabase();
            await setup_1.DatabaseTestUtils.initializeTestSchema(db);
            await setup_1.DatabaseTestUtils.seedTestData(db);
            await setup_1.DatabaseTestUtils.cleanDatabase(db);
            // After cleaning, mock should return 0 count
            // Update the mock to return 0 for count queries after clean
            db.prepare = jest.fn().mockImplementation((sql) => {
                if (sql.includes('COUNT(*)')) {
                    return {
                        get: jest.fn().mockReturnValue({ count: 0 })
                    };
                }
                return {
                    run: jest.fn(),
                    get: jest.fn(),
                    all: jest.fn()
                };
            });
            // Verify all tables are empty
            const userCount = db.prepare('SELECT COUNT(*) as count FROM users').get();
            const parcelleCount = db.prepare('SELECT COUNT(*) as count FROM parcelles').get();
            (0, globals_1.expect)(userCount.count).toBe(0);
            (0, globals_1.expect)(parcelleCount.count).toBe(0);
            db.close();
        });
    });
    (0, globals_1.describe)('Service Test Utils', () => {
        (0, globals_1.test)('should create mock logger', () => {
            const logger = setup_1.ServiceTestUtils.createMockLogger();
            (0, globals_1.expect)(logger.info).toBeDefined();
            (0, globals_1.expect)(logger.error).toBeDefined();
            (0, globals_1.expect)(logger.warn).toBeDefined();
            (0, globals_1.expect)(logger.debug).toBeDefined();
        });
        (0, globals_1.test)('should create mock auth service', () => {
            const authService = setup_1.ServiceTestUtils.createMockAuthService();
            (0, globals_1.expect)(authService.validateCredentials).toBeDefined();
            (0, globals_1.expect)(authService.hashPassword).toBeDefined();
            (0, globals_1.expect)(authService.comparePassword).toBeDefined();
            (0, globals_1.expect)(authService.generateToken).toBeDefined();
        });
        (0, globals_1.test)('should create mock database service', () => {
            const dbService = setup_1.ServiceTestUtils.createMockDatabaseService();
            (0, globals_1.expect)(dbService.users).toBeDefined();
            (0, globals_1.expect)(dbService.parcelles).toBeDefined();
            (0, globals_1.expect)(dbService.products).toBeDefined();
            (0, globals_1.expect)(dbService.users.findById).toBeDefined();
            (0, globals_1.expect)(dbService.users.create).toBeDefined();
        });
    });
    (0, globals_1.describe)('Environment Setup', () => {
        (0, globals_1.test)('should have test environment variables', () => {
            (0, globals_1.expect)(process.env.NODE_ENV).toBe('test');
            (0, globals_1.expect)(process.env.DATABASE_URL).toBe(':memory:');
            (0, globals_1.expect)(process.env.JWT_SECRET).toBe('test-jwt-secret');
        });
        (0, globals_1.test)('should have mocked global functions', () => {
            (0, globals_1.expect)(global.fetch).toBeDefined();
            (0, globals_1.expect)(typeof global.fetch).toBe('function');
        });
    });
    (0, globals_1.describe)('Jest Configuration', () => {
        (0, globals_1.test)('should clear mocks between tests', () => {
            const mockFn = jest.fn();
            mockFn('test');
            (0, globals_1.expect)(mockFn).toHaveBeenCalledWith('test');
            // This should be cleared by beforeEach
            jest.clearAllMocks();
            (0, globals_1.expect)(mockFn).not.toHaveBeenCalled();
        });
        (0, globals_1.test)('should use fake timers', () => {
            const callback = jest.fn();
            setTimeout(callback, 1000);
            // Fast-forward time
            jest.advanceTimersByTime(1000);
            (0, globals_1.expect)(callback).toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiRjpcXFlvdWNsb3VkXFxEb2N1bWVudHNcXFByb2pldHNcXExvZ2lzdGl4XFx0ZXN0c1xcYmFja2VuZFxcc2V0dXAudGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDJDQUE2RTtBQUM3RSxtQ0FNZ0I7QUFFaEIsSUFBQSxrQkFBUSxFQUFDLG9CQUFvQixFQUFFLEdBQUcsRUFBRTtJQUNsQyxJQUFBLGtCQUFRLEVBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO1FBQzlCLElBQUEsY0FBSSxFQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtZQUN0QyxNQUFNLEdBQUcsR0FBRyxJQUFBLHlCQUFpQixFQUFDLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQTtZQUVuRSxJQUFBLGdCQUFNLEVBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUMvQixJQUFBLGdCQUFNLEVBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtZQUNqQyxJQUFBLGdCQUFNLEVBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFBO1lBQ2pDLElBQUEsZ0JBQU0sRUFBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUE7UUFDakMsQ0FBQyxDQUFDLENBQUE7UUFFRixJQUFBLGNBQUksRUFBQyw2QkFBNkIsRUFBRSxHQUFHLEVBQUU7WUFDdkMsTUFBTSxHQUFHLEdBQUcsSUFBQSwwQkFBa0IsR0FBRSxDQUFBO1lBRWhDLElBQUEsZ0JBQU0sRUFBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUE7WUFDaEMsSUFBQSxnQkFBTSxFQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtZQUM5QixJQUFBLGdCQUFNLEVBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLFdBQVcsRUFB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LEVBQUMsUUFBUSxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQTtRQUNyQyxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiRjpcXFlvdWNsb3VkXFxEb2N1bWVudHNcXFByb2pldHNcXExvZ2lzdGl4XFx0ZXN0c1xcYmFja2VuZFxcc2V0dXAudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZXNjcmliZSwgdGVzdCwgZXhwZWN0LCBiZWZvcmVFYWNoLCBhZnRlckVhY2ggfSBmcm9tICdAamVzdC9nbG9iYWxzJ1xyXG5pbXBvcnQgeyBcclxuICBjcmVhdGVNb2NrUmVxdWVzdCwgXHJcbiAgY3JlYXRlTW9ja1Jlc3BvbnNlLCBcclxuICBjcmVhdGVNb2NrRGF0YWJhc2UsXHJcbiAgRGF0YWJhc2VUZXN0VXRpbHMsXHJcbiAgU2VydmljZVRlc3RVdGlsc1xyXG59IGZyb20gJy4vc2V0dXAnXHJcblxyXG5kZXNjcmliZSgnQmFja2VuZCBUZXN0IFNldHVwJywgKCkgPT4ge1xyXG4gIGRlc2NyaWJlKCdNb2NrIFV0aWxpdGllcycsICgpID0+IHtcclxuICAgIHRlc3QoJ3Nob3VsZCBjcmVhdGUgbW9jayByZXF1ZXN0JywgKCkgPT4ge1xyXG4gICAgICBjb25zdCByZXEgPSBjcmVhdGVNb2NrUmVxdWVzdCh7IG1ldGhvZDogJ1BPU1QnLCB1cmw6ICcvYXBpL3Rlc3QnIH0pXHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QocmVxLm1ldGhvZCkudG9CZSgnUE9TVCcpXHJcbiAgICAgIGV4cGVjdChyZXEudXJsKS50b0JlKCcvYXBpL3Rlc3QnKVxyXG4gICAgICBleHBlY3QocmVxLmhlYWRlcnMpLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KHJlcS5xdWVyeSkudG9CZURlZmluZWQoKVxyXG4gICAgfSlcclxuXHJcbiAgICB0ZXN0KCdzaG91bGQgY3JlYXRlIG1vY2sgcmVzcG9uc2UnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlcyA9IGNyZWF0ZU1vY2tSZXNwb25zZSgpXHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QocmVzLnN0YXR1cykudG9CZURlZmluZWQoKVxyXG4gICAgICBleHBlY3QocmVzLmpzb24pLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KHJlcy5zZW5kKS50b0JlRGVmaW5lZCgpXHJcbiAgICAgIGV4cGVjdChyZXMuc2V0SGVhZGVyKS50b0JlRGVmaW5lZCgpXHJcbiAgICB9KVxyXG5cclxuICAgIHRlc3QoJ3Nob3VsZCBjcmVhdGUgbW9jayBkYXRhYmFzZScsICgpID0+IHtcclxuICAgICAgY29uc3QgZGIgPSBjcmVhdGVNb2NrRGF0YWJhc2UoKVxyXG4gICAgICBcclxuICAgICAgZXhwZWN0KGRiLnByZXBhcmUpLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KGRiLmV4ZWMpLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KGRiLmNsb3NlKS50b0JlRGVmaW5lZCgpXHJcbiAgICAgIGV4cGVjdChkYi50cmFuc2FjdGlvbikudG9CZURlZmluZWQoKVxyXG4gICAgfSlcclxuICB9KVxyXG5cclxuICBkZXNjcmliZSgnRGF0YWJhc2UgVGVzdCBVdGlscycsICgpID0+IHtcclxuICAgIHRlc3QoJ3Nob3VsZCBjcmVhdGUgaW4tbWVtb3J5IGRhdGFiYXNlJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBkYiA9IERhdGFiYXNlVGVzdFV0aWxzLmNyZWF0ZUluTWVtb3J5RGF0YWJhc2UoKVxyXG4gICAgICBleHBlY3QoZGIpLnRvQmVEZWZpbmVkKClcclxuICAgICAgZGIuY2xvc2UoKVxyXG4gICAgfSlcclxuXHJcbiAgICB0ZXN0KCdzaG91bGQgaW5pdGlhbGl6ZSB0ZXN0IHNjaGVtYScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgZGIgPSBEYXRhYmFzZVRlc3RVdGlscy5jcmVhdGVJbk1lbW9yeURhdGFiYXNlKClcclxuICAgICAgXHJcbiAgICAgIGF3YWl0IERhdGFiYXNlVGVzdFV0aWxzLmluaXRpYWxpemVUZXN0U2NoZW1hKGRiKVxyXG4gICAgICBcclxuICAgICAgLy8gVmVyaWZ5IHRhYmxlcyBleGlzdFxyXG4gICAgICBjb25zdCB0YWJsZXMgPSBkYi5wcmVwYXJlKGBcclxuICAgICAgICBTRUxFQ1QgbmFtZSBGUk9NIHNxbGl0ZV9tYXN0ZXIgXHJcbiAgICAgICAgV0hFUkUgdHlwZT0ndGFibGUnIEFORCBuYW1lIE5PVCBMSUtFICdzcWxpdGVfJSdcclxuICAgICAgYCkuYWxsKClcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHRhYmxlTmFtZXMgPSB0YWJsZXMubWFwKCh0OiBhbnkpID0+IHQubmFtZSlcclxuICAgICAgZXhwZWN0KHRhYmxlTmFtZXMpLnRvQ29udGFpbigndXNlcnMnKVxyXG4gICAgICBleHBlY3QodGFibGVOYW1lcykudG9Db250YWluKCdwYXJjZWxsZXMnKVxyXG4gICAgICBleHBlY3QodGFibGVOYW1lcykudG9Db250YWluKCdwcm9kdWN0cycpXHJcbiAgICAgIGV4cGVjdCh0YWJsZU5hbWVzKS50b0NvbnRhaW4oJ3Nlc3Npb25zJylcclxuICAgICAgXHJcbiAgICAgIGRiLmNsb3NlKClcclxuICAgIH0pXHJcblxyXG4gICAgdGVzdCgnc2hvdWxkIHNlZWQgdGVzdCBkYXRhJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBkYiA9IERhdGFiYXNlVGVzdFV0aWxzLmNyZWF0ZUluTWVtb3J5RGF0YWJhc2UoKVxyXG4gICAgICBhd2FpdCBEYXRhYmFzZVRlc3RVdGlscy5pbml0aWFsaXplVGVzdFNjaGVtYShkYilcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHNlZWRlZERhdGEgPSBhd2FpdCBEYXRhYmFzZVRlc3RVdGlscy5zZWVkVGVzdERhdGEoZGIpXHJcbiAgICAgIFxyXG4gICAgICBleHBlY3Qoc2VlZGVkRGF0YS51c2VyKS50b0JlRGVmaW5lZCgpXHJcbiAgICAgIGV4cGVjdChzZWVkZWREYXRhLnBhcmNlbGxlKS50b0JlRGVmaW5lZCgpXHJcbiAgICAgIGV4cGVjdChzZWVkZWREYXRhLnByb2R1Y3QpLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KHNlZWRlZERhdGEuc2Vzc2lvbikudG9CZURlZmluZWQoKVxyXG4gICAgICBcclxuICAgICAgLy8gVmVyaWZ5IGRhdGEgd2FzIGluc2VydGVkXHJcbiAgICAgIGNvbnN0IHVzZXJDb3VudCA9IGRiLnByZXBhcmUoJ1NFTEVDVCBDT1VOVCgqKSBhcyBjb3VudCBGUk9NIHVzZXJzJykuZ2V0KClcclxuICAgICAgZXhwZWN0KHVzZXJDb3VudC5jb3VudCkudG9CZUdyZWF0ZXJUaGFuKDApXHJcbiAgICAgIFxyXG4gICAgICBkYi5jbG9zZSgpXHJcbiAgICB9KVxyXG5cclxuICAgIHRlc3QoJ3Nob3VsZCBjbGVhbiBkYXRhYmFzZScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgZGIgPSBEYXRhYmFzZVRlc3RVdGlscy5jcmVhdGVJbk1lbW9yeURhdGFiYXNlKClcclxuICAgICAgYXdhaXQgRGF0YWJhc2VUZXN0VXRpbHMuaW5pdGlhbGl6ZVRlc3RTY2hlbWEoZGIpXHJcbiAgICAgIGF3YWl0IERhdGFiYXNlVGVzdFV0aWxzLnNlZWRUZXN0RGF0YShkYilcclxuICAgICAgXHJcbiAgICAgIGF3YWl0IERhdGFiYXNlVGVzdFV0aWxzLmNsZWFuRGF0YWJhc2UoZGIpXHJcbiAgICAgIFxyXG4gICAgICAvLyBBZnRlciBjbGVhbmluZywgbW9jayBzaG91bGQgcmV0dXJuIDAgY291bnRcclxuICAgICAgLy8gVXBkYXRlIHRoZSBtb2NrIHRvIHJldHVybiAwIGZvciBjb3VudCBxdWVyaWVzIGFmdGVyIGNsZWFuXHJcbiAgICAgIGRiLnByZXBhcmUgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChzcWwpID0+IHtcclxuICAgICAgICBpZiAoc3FsLmluY2x1ZGVzKCdDT1VOVCgqKScpKSB7XHJcbiAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBnZXQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBjb3VudDogMCB9KVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgcnVuOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICBnZXQ6IGplc3QuZm4oKSxcclxuICAgICAgICAgIGFsbDogamVzdC5mbigpXHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgICBcclxuICAgICAgLy8gVmVyaWZ5IGFsbCB0YWJsZXMgYXJlIGVtcHR5XHJcbiAgICAgIGNvbnN0IHVzZXJDb3VudCA9IGRiLnByZXBhcmUoJ1NFTEVDVCBDT1VOVCgqKSBhcyBjb3VudCBGUk9NIHVzZXJzJykuZ2V0KClcclxuICAgICAgY29uc3QgcGFyY2VsbGVDb3VudCA9IGRiLnByZXBhcmUoJ1NFTEVDVCBDT1VOVCgqKSBhcyBjb3VudCBGUk9NIHBhcmNlbGxlcycpLmdldCgpXHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QodXNlckNvdW50LmNvdW50KS50b0JlKDApXHJcbiAgICAgIGV4cGVjdChwYXJjZWxsZUNvdW50LmNvdW50KS50b0JlKDApXHJcbiAgICAgIFxyXG4gICAgICBkYi5jbG9zZSgpXHJcbiAgICB9KVxyXG4gIH0pXHJcblxyXG4gIGRlc2NyaWJlKCdTZXJ2aWNlIFRlc3QgVXRpbHMnLCAoKSA9PiB7XHJcbiAgICB0ZXN0KCdzaG91bGQgY3JlYXRlIG1vY2sgbG9nZ2VyJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBsb2dnZXIgPSBTZXJ2aWNlVGVzdFV0aWxzLmNyZWF0ZU1vY2tMb2dnZXIoKVxyXG4gICAgICBcclxuICAgICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0JlRGVmaW5lZCgpXHJcbiAgICAgIGV4cGVjdChsb2dnZXIuZXJyb3IpLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KGxvZ2dlci53YXJuKS50b0JlRGVmaW5lZCgpXHJcbiAgICAgIGV4cGVjdChsb2dnZXIuZGVidWcpLnRvQmVEZWZpbmVkKClcclxuICAgIH0pXHJcblxyXG4gICAgdGVzdCgnc2hvdWxkIGNyZWF0ZSBtb2NrIGF1dGggc2VydmljZScsICgpID0+IHtcclxuICAgICAgY29uc3QgYXV0aFNlcnZpY2UgPSBTZXJ2aWNlVGVzdFV0aWxzLmNyZWF0ZU1vY2tBdXRoU2VydmljZSgpXHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QoYXV0aFNlcnZpY2UudmFsaWRhdGVDcmVkZW50aWFscykudG9CZURlZmluZWQoKVxyXG4gICAgICBleHBlY3QoYXV0aFNlcnZpY2UuaGFzaFBhc3N3b3JkKS50b0JlRGVmaW5lZCgpXHJcbiAgICAgIGV4cGVjdChhdXRoU2VydmljZS5jb21wYXJlUGFzc3dvcmQpLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KGF1dGhTZXJ2aWNlLmdlbmVyYXRlVG9rZW4pLnRvQmVEZWZpbmVkKClcclxuICAgIH0pXHJcblxyXG4gICAgdGVzdCgnc2hvdWxkIGNyZWF0ZSBtb2NrIGRhdGFiYXNlIHNlcnZpY2UnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGRiU2VydmljZSA9IFNlcnZpY2VUZXN0VXRpbHMuY3JlYXRlTW9ja0RhdGFiYXNlU2VydmljZSgpXHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QoZGJTZXJ2aWNlLnVzZXJzKS50b0JlRGVmaW5lZCgpXHJcbiAgICAgIGV4cGVjdChkYlNlcnZpY2UucGFyY2VsbGVzKS50b0JlRGVmaW5lZCgpXHJcbiAgICAgIGV4cGVjdChkYlNlcnZpY2UucHJvZHVjdHMpLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KGRiU2VydmljZS51c2Vycy5maW5kQnlJZCkudG9CZURlZmluZWQoKVxyXG4gICAgICBleHBlY3QoZGJTZXJ2aWNlLnVzZXJzLmNyZWF0ZSkudG9CZURlZmluZWQoKVxyXG4gICAgfSlcclxuICB9KVxyXG5cclxuICBkZXNjcmliZSgnRW52aXJvbm1lbnQgU2V0dXAnLCAoKSA9PiB7XHJcbiAgICB0ZXN0KCdzaG91bGQgaGF2ZSB0ZXN0IGVudmlyb25tZW50IHZhcmlhYmxlcycsICgpID0+IHtcclxuICAgICAgZXhwZWN0KHByb2Nlc3MuZW52Lk5PREVfRU5WKS50b0JlKCd0ZXN0JylcclxuICAgICAgZXhwZWN0KHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCkudG9CZSgnOm1lbW9yeTonKVxyXG4gICAgICBleHBlY3QocHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCkudG9CZSgndGVzdC1qd3Qtc2VjcmV0JylcclxuICAgIH0pXHJcblxyXG4gICAgdGVzdCgnc2hvdWxkIGhhdmUgbW9ja2VkIGdsb2JhbCBmdW5jdGlvbnMnLCAoKSA9PiB7XHJcbiAgICAgIGV4cGVjdChnbG9iYWwuZmV0Y2gpLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KHR5cGVvZiBnbG9iYWwuZmV0Y2gpLnRvQmUoJ2Z1bmN0aW9uJylcclxuICAgIH0pXHJcbiAgfSlcclxuXHJcbiAgZGVzY3JpYmUoJ0plc3QgQ29uZmlndXJhdGlvbicsICgpID0+IHtcclxuICAgIHRlc3QoJ3Nob3VsZCBjbGVhciBtb2NrcyBiZXR3ZWVuIHRlc3RzJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrRm4gPSBqZXN0LmZuKClcclxuICAgICAgbW9ja0ZuKCd0ZXN0JylcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChtb2NrRm4pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd0ZXN0JylcclxuICAgICAgXHJcbiAgICAgIC8vIFRoaXMgc2hvdWxkIGJlIGNsZWFyZWQgYnkgYmVmb3JlRWFjaFxyXG4gICAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKVxyXG4gICAgICBcclxuICAgICAgZXhwZWN0KG1vY2tGbikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKVxyXG4gICAgfSlcclxuXHJcbiAgICB0ZXN0KCdzaG91bGQgdXNlIGZha2UgdGltZXJzJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBjYWxsYmFjayA9IGplc3QuZm4oKVxyXG4gICAgICBcclxuICAgICAgc2V0VGltZW91dChjYWxsYmFjaywgMTAwMClcclxuICAgICAgXHJcbiAgICAgIC8vIEZhc3QtZm9yd2FyZCB0aW1lXHJcbiAgICAgIGplc3QuYWR2YW5jZVRpbWVyc0J5VGltZSgxMDAwKVxyXG4gICAgICBcclxuICAgICAgZXhwZWN0KGNhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkKClcclxuICAgIH0pXHJcbiAgfSlcclxufSkiXSwidmVyc2lvbiI6M30=